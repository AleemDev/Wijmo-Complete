/*
 *
 * Wijmo Library 0.8.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){a.widget("ui.wijbarchart",a.ui.wijchartcore,{options:{stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:"easeOutExpo"}},_create:function(){var b=["0-#8ac4c0-#77b3af","0-#73a19e-#67908e","0-#4f687b-#465d6e","0-#69475b-#5d3f51","0-#7a3b3f-#682e32","0-#9d5b5b-#8c5151","0-#e5a36d-#ce9262","0-#e6cc70-#ceb664","0-#8ec858-#7fb34f","0-#3a9073-#2a7b5f","0-#6c88e3-#6079cb","0-#6cb4e3-#60a0cb"];a.extend(true,this.options.axis,{x:{compass:"west"},y:{compass:"south"}});a.ui.wijchartcore.prototype._create.apply(this,arguments);this.chartElement.addClass("ui-wijbarchart");a.extend(true,{compass:"east"},this.options.hint);a.each(this.options.seriesStyles,function(c,a){if(a.fill==null)a.fill=b[c]})},destroy:function(){this.chartElement.removeClass("ui-wijbarchart ui-helper-reset");a.ui.wijchartcore.prototype.destroy.apply(this,arguments)},getBar:function(a){return this.bars[a]},_get_clusterOverlap:function(a){return a/100},_get_clusterWidth:function(a){return a/100},_adjustToLimits:function(a,c,b){return a<c?c:a>b?b:a},_transformPoints:function(c,d,e,f,b){a.each(b,function(h,a){var b=a.x,g=a.y;a.y=c*b+e;a.x=d*g+f});return b},_paintPlotArea:function(){var f=this.options,M=a.extend(true,{visible:true},f.plotArea);if(!M||!M.visible)return;var u=f.stacked,X=u&&f.is100Percent,x=f.seriesList,t=x.length,J=f.seriesStyles.slice(0,t),I=f.seriesHoverStyles.slice(0,t),j=f.axis.x,k=f.axis.y,q=this._get_clusterOverlap(f.clusterOverlap),W=this._get_clusterWidth(f.clusterWidth),r={x:this.canvasBounds.startX,y:this.canvasBounds.startY},gb=this.canvasBounds.endX-r.x,O=this.canvasBounds.endY-r.y,m={},S=[],C=[],D=1,V=f.clusterSpacing+D,i=null,bb=true;if(bb&&!u){x.reverse();J.reverse();I.reverse()}if(t>0){var v=this._barPointList(x);if(u)v=this._stackValues(v);var N=v.length,fb=this._getMinDX(v),hb=fb*W,B=hb,K=this.canvas.set(),s=f.animation,L=s&&s.enabled,E=this._getScaling(true,j.max,j.min,O),F=this._getScaling(false,k.max,k.min,gb),Q=this._getTranslation(true,r,j.max,j.min,E),R=this._getTranslation(false,r,k.max,k.min,F);m.xscale=E;m.yscale=F;m.xlate=Q;m.ylate=R;if(t>1&&!u){q-=N*(t-1)*V/O;B/=t*(1-q)+q}for(var w=0;w<N;w++){var T=v[w],e=T.paSpec,ib=e.length,H;if(u)H=B;else H=B*(ib*(1-q)+q);for(var h={x:T.x-H/2,y:0,width:B,height:e[0].y},d=0;d<e.length;d++){var y=x[e[d].sIdx],n=J[e[d].sIdx],U=I[e[d].sIdx];if(u)if(X){var z=e[e.length-1].y;if(z>0)h.height=e[d].y/z;if(d>0){h.height-=e[d-1].y/z;h.y=e[d-1].y/z}}else{h.height=e[d].y;if(d>0){h.height-=e[d-1].y;h.y=e[d-1].y}}else if(d>0){h.x+=h.width*(1-q);h.height=e[d].y}var b=[{x:h.x,y:h.y},{x:h.x+h.width,y:h.y+h.height}],Y=(j.min<=b[0].x&&b[0].x<=j.max||j.min<=b[1].x&&b[1].x<=j.max)&&(k.min<=b[0].y&&b[0].y<=k.max||k.min<=b[1].y&&b[1].y<=k.max);b[0].x=this._adjustToLimits(b[0].x,j.min,j.max);b[0].y=this._adjustToLimits(b[0].y,k.min,k.max);b[1].x=this._adjustToLimits(b[1].x,j.min,j.mMax);b[1].y=this._adjustToLimits(b[1].y,k.min,k.max);b=this._transformPoints(E,F,Q,R,b);var A=0;if(b[0].x>b[1].x){A=b[0].x;b[0].x=b[1].x;b[1].x=A}if(b[0].y>b[1].y){A=b[0].y;b[0].y=b[1].y;b[1].y=A}var c={x:b[0].x,y:b[0].y,width:b[1].x-b[0].x,height:b[1].y-b[0].y};if(Y){if(c.width==0)c.width=.5;if(c.height==0)c.height=.5}if(m.rects==null)m.rects=[];if(m.rects[d]==null)m.rects[d]=[];m.rects[d][w]=c;var p=null;if(f.showDefaultChartLabels){var Z=a.extend(true,{},f.textStyle,f.chartLabelStyle);p=this._text(c.x+c.width,c.y+c.height/2,e[d].y).attr(Z);var cb=p.getBBox();p.translate(cb.width/2,0);K.push(p)}var l=null,o=n.r?n.r:f.clusterRadius,P=n=a.extend(true,{fill:"#fff","fill-opacity":1,stroke:"#000","stroke-dasharray":"","stroke-opacity":1,"stroke-width":1},n);if(o)P=a.extend(true,{},n,{r:0});var g=n["stroke-width"],eb=n.stroke;if(eb!="none"&&g)g=parseInt(g);if(!g||isNaN(g))g=0;if(L){if(o){l=this.canvas.wij.roundRect(c.x,c.y,c.width-g,c.height-g,0,0,o,o).hide();i=this.canvas.rect(r.x,c.y,0,c.height-g);this._paintShadow(i,D);i.wijAttr(P);i.bar=l}else{l=this.canvas.rect(r.x,c.y,0,c.height-g);i=l}if(p){p.attr({opacity:0});i.chartLabel=p}i.left=c.x;i.width=c.width-g;i.r=o}else if(o)l=this.canvas.wij.roundRect(c.x,c.y,c.width-g,c.height-g,0,0,o,o);else l=this.canvas.rect(c.x,c.y,c.width-g,c.height-g);this._paintShadow(l,D);l.wijAttr(n);y.type="bar";y.style=n;y.hoverStyle=U;this._addClass(a(l.node),"wijchart-canvas-object");a(l.node).data("wijchartDataObj",a.extend(true,{index:w,bar:l},y));S.push(l);C.push(i)}}this.chartElement.data("plotInfos",m);a.each(K,function(b,a){a.toFront()})}if(L)for(var ab=s.duration?s.duration:2e3,db=s.easing?s.easing:"linear",G=0;G<C.length;G++){i=C[G];i.wijAnimate({width:i.width,x:i.left},ab,db,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.animate({opacity:1},250);if(c){b=a.bar;b.show();if(a.shadow){a.shadow.remove();a.shadow=null}a.remove();a=null}})}this.bars=S},_getChartLabelPointPosition:function(i){var n=this.options,l=i.attachMethod,d=i.attachMethodData,f={x:0,y:0},a=null,e=null,g=null,b=null,c=null;switch(l){case"coordinate":f.x=d.x;f.y=d.y;break;case"dataCoordinate":a=this.chartElement.data("plotInfos");b=d.x;c=d.y;if(this._isDate(b))b=this._toOADate(b);if(this._isDate(c))c=this._toOADate(c);f=this._transformPoints(a.xscale,a.yscale,a.xlate,a.ylate,{x:b,y:c});break;case"dataIndex":e=d.seriesIndex;g=d.pointIndex;a=this.chartElement.data("plotInfos");if(e>-1){var j=a.rects;if(j.length>e){var m=j[e],h=m[g];f.x=h.x+h.width;f.y=h.y+h.height/2}}break;case"dataIndexY":e=d.seriesIndex;g=d.pointIndex;if(e>-1){var k=n.seriesList[e].data;b=k.x[g];c=d.y;a=this.chartElement.data("plotInfos");if(this._isDate(b))b=this._toOADate(b);if(this._isDate(c))c=this._toOADate(c);f=this._transformPoints(a.xscale,a.yscale,a.xlate,a.ylate,{x:b,y:c})}}return f},_bindLiveEvents:function(){var c=this.options,b=this,d={mousedown:function(b){this._trigger("mousedown",b,a(b.target).data("wijchartDataObj"))},mouseup:function(b){this._trigger("mouseup",b,a(b.target).data("wijchartDataObj"))},mouseover:function(b){this._trigger("mouseover",b,a(b.target).data("wijchartDataObj"))},mouseout:function(b){this._trigger("mouseout",b,a(b.target).data("wijchartDataObj"))},mousemove:function(b){this._trigger("mousemove",b,a(b.target).data("wijchartDataObj"))},click:function(b){this._trigger("click",b,a(b.target).data("wijchartDataObj"))}};a(".wijchart-canvas-object",this.chartElement[0]).live("mousedown.wijbarchart",a.proxy(d.mousedown,this)).live("mouseup.wijbarchart",a.proxy(d.mouseup,this)).live("mouseover.wijbarchart",a.proxy(d.mouseover,this)).live("mouseout.wijbarchart",a.proxy(d.mouseout,this)).live("mousemove.wijbarchart",a.proxy(d.mousemove,this)).live("click.wijbarchart",a.proxy(d.click,this));a(".wijchart-canvas-object",this.chartElement[0]).live("mouseout.wijbarchart",function(){var c=a(this).data("wijchartDataObj"),d=c.bar;if(!c.hoverStyle)d&&d.attr({opacity:"1"});else d.attr(c.style);b.tooltipEle&&b.tooltipEle.hide()});a(".wijchart-canvas-object",this.chartElement[0]).live("mousemove.wijbarchart",function(p){var e=a(this).data("wijchartDataObj"),k=e.bar;if(!e.hoverStyle)k&&k.attr({opacity:"0.8"});else k.attr(e.hoverStyle);if(c.hint.enable){if(!b.tooltipEle)b.tooltipEle=b.canvas.wij.tooltip(b);var h=e.index,d=e.data,l=b.chartElement.offset(),m={x:p.pageX,y:p.pageY},j,g;if(d.x){j=d.x[h];g=d.y[h]}else{j=d.xy[2*h];g=d.xy[2*h+1]}d={data:e,content:"",cancel:false,offset:c.hint.offset||3,compass:c.hint.compass,showDelay:c.hint.showDelay,hideDelay:c.hint.hideDelay,textStyle:c.hint.textStyle,duration:c.hint.duration,easing:c.hint.easing,style:c.hint.style,x:j,y:g,index:h};var q={x:m.x-l.left+d.offset,y:m.y-l.top-d.offset};b.element.trigger("hintShowing",d);if(!d.cancel){var f=d.content,i=c.hint.formatter;if(!f)if(i===null)f=g;else if(a.isFunction(i)){var o={x:j,y:g,data:e,fmt:i},r=a.proxy(o.fmt,o);f=r()}else f=i;var n=e.style;b.tooltipEle.showDelay=d.showDelay;b.tooltipEle.hideDelay=d.hideDelay;b.tooltipEle.duration=d.duration;b.tooltipEle.easing=d.easing;b.tooltipEle.textAttr=a.extend(true,{},c.textStyle,d.textStyle);b.tooltipEle.rectAttr=a.extend({stroke:n.stroke||n.fill,"stroke-opacity":"0.9"},d.style);b.tooltipEle.text=f;b.tooltipEle.offset=d.offset;b.tooltipEle.compass=d.compass;b.tooltipEle.showAt(q,200);b._trigger("hintshown",null,d)}}})},_unbindLiveEvents:function(){a(".wijchart-canvas-object",this.chartElement[0]).die("wijbarchart")},_calculateParameters:function(c,e){a.ui.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id=="x"){var d=e.unitMinor,g=e.autoMin,f=e.autoMax,b=this._getBarAdjustment(c);if(b==0)b=d;else if(d<b&&d!=0)b=Math.floor(b/d)*d;if(g)c.min-=b;if(f)c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(c){for(var a=0,h=this.options,d=c.max,b=c.min,f=h.seriesList,e=0;e<f.length;e++){var g=f[e].data.x.length;if(a<g)a=g}if(a>1)return(d-b)/a*h.clusterWidth*.0125;else if(a==1){if(b==0&&d==1){b=-1;c.min=b}return(d-b)*.0125}else return 0}});a.extend(a.ui.wijbarchart.prototype,{_barPointList:function(f){var b=[],d=this._getXSortedPoints;function c(a){this.x=a;this.paSpec=[];this.stackValues=function(){var b=this.paSpec.length;if(b>1)for(var c=this.paSpec[0],a=1;a<b;a++){var d=this.paSpec[a];d.y+=c.y;c=d}}}function e(o,m){var e=d(m),l=m.length,g=null,n=0;if(e!=null)n=e.length;var f=0,h=0;if(b!=null)h=b.length;for(var k=true,i=0,j=false,a=0;a<n;a++){if(k){k=false;i=e[a].x}else{if(i==e[a].x)j=true;else j=false;i=e[a].x}while(f<h&&b[f].x<e[a].x)f++;if(f<h)if(b[f].x!=e[a].x){g=new c(e[a].x,l);b.splice(f,0,g);h=b.length}else g=b[f];else{g=new c(e[a].x,l);b.push(g);h=b.length}g.paSpec.push({y:e[a].y,sIdx:o,pIdx:a,dupl:j})}}a.each(f,function(b,a){e(b,a)});return b},_getSpecWithValue:function(a){for(var d=a.length,b=0;b<d;b++){var c=a[b];if(c.x>=a)return c.x==a?c:null}return null},_getMinDX:function(d){for(var a=Number.MAX_VALUE,e=d.length,b=1;b<e;b++){var c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a==Number.MAX_VALUE?2:a},_stackValues:function(b){a.each(b,function(b,a){a.stackValues()});return b}})})(jQuery);