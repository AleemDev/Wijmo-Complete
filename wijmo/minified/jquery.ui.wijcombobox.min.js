/*
 *
 * Wijmo Library 0.8.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){var g="ui-wijcombobox-input",c="ui-state-hover",d="ui-state-active",b="ui-state-focus",f="ui-corner-left",e="ui-corner-right",h="<div class='ui-wijcombobox-trigger ui-state-default ui-corner-right'><span class='ui-icon ui-icon-triangle-1-s'></span></div>",i="<label class='ui-wijcombobox-label ui-widget-content'></label>";a.widget("ui.wijcombobox",{options:{data:null,labelText:null,minLength:4,delay:300,showingAnimation:null,hidingAnimation:null,showTrigger:true,triggerPosition:"right",dropdownHeight:300,dropdownWidth:"auto",selectOnItemFocus:false,autoFilter:true,autoComplete:true,highlightMatching:true,dropDownListPosition:{},columns:[],selectionMode:"single",multipleSelectionSeparator:",",forceSelectionText:false,select:null,isEditable:true,selectedIndex:-1,open:null,close:null,selectElementWidthFix:6,search:null,changed:null},_create:function(){var a=this;a.selectedItem=null;a.selectedItems=[];a._createDOMElements();a._bindInputEvents();a._initDropDownList();a.repaint();a._checkSelectIndex()},_checkSelectIndex:function(){var b=this,d=b.options,c=d.selectedIndex;!b._usingRemoteData()&&(c>=0||a.isArray(c))&&b.search(null,"checkindex")},repaint:function(){var a=this;if(a.element.is(":visible")||a._select!=undefined&&a._input.is(":visible")){a._showTrigger();a.options.disabled&&a.disable();return true}return false},_bindInputEvents:function(){var c=this,d=c._input,e=c.options;d.bind("keydown.wijcombobox",function(f){if(e.disabled==true)return;var g=f.keyCode,b=a.ui.keyCode;switch(g){case b.UP:c._move("previous",f);f.preventDefault();break;case b.DOWN:c._move("next",f);f.preventDefault();break;case b.ENTER:c.menu.active&&f.preventDefault();case b.TAB:d.trigger("wijcomboblur");if(!c.menu.active||e.selectionMode=="multiple"&&b.TAB===g)return;c.menu.select(f);var h=d.val().length;c._selectText(h,h,d);break;case b.ESCAPE:c.close(f);break;case b.LEFT:case b.RIGHT:case b.SHIFT:case b.CONTROL:case b.HOME:case b.END:case b.DELETE:case b.PAGE_UP:case b.PAGE_DOWN:break;case 18:d.trigger("wijcomboblur");default:clearTimeout(c.searching);if(e.isEditable==false){if(c._cacheKey==undefined)c._cacheKey="";c._cacheKey+=String.fromCharCode(g)}c.searching=setTimeout(function(){var a;if(e.isEditable==false){a=c._cacheKey;c._cacheKey=undefined}else a=d.val();c.search(a,f)},e.delay)}}).bind("wijcomboblur.wijcombobox",function(a){clearTimeout(c.searching);c._addInputFocus(false,b);c.closing=setTimeout(function(){c.close(a,true)},150)}).bind("focus.wijcombobox",function(){c._addInputFocus(true,b)}).bind("blur.wiicombobox",function(){!c.menu.element.is(":visible")&&d.trigger("wijcomboblur");c._change()})},_addInputFocus:function(f,c){var b=this,e=b._input.parent(),d=f?"addClass":"removeClass",a=b._triggerArrow;e[d](c);a!=undefined&&a[d](c)},_renderColumnsHeader:function(c){var b=a("<ul class='ui-wijcombobox-rowheader'></ul>");a.each(this.options.columns,function(e,c){var d=a("<li class='ui-wijcombobox-cell ui-widget-header'></li>");d.html(c.name);c.width!=undefined&&d.width(c.width);d.appendTo(b)});c.append(b)},_hasSameValueText:function(a,b){return a.label===b.label&&a.value===b.value},_initDropDownList:function(){var b=this,f=b.element[0].ownerDocument,d=a("<div class='ui-wijcombobox-list'></div>"),c=b.options;if(c.columns.length>0){d.addClass("ui-wijcombobox-multicolumn");var e=a("<div class='ui-wijsuperpanel-header ui-state-default'></div>");b._renderColumnsHeader(e);d.append(e)}b.menu=d.appendTo("body",f).wijlist({keepHightlightOnMouseLeave:true,selectionMode:c.selectionMode,addHoverItemClass:!(c.columns.length>0),focus:function(e,d){var a=d;c.selectOnItemFocus&&b.menu.select(null,{notCloseAfterSelected:true});if(c.columns.length>0){a.element.prev().addClass("ui-wijcombobox-active-prev");a.element.find(".ui-wijcombobox-row>.ui-wijcombobox-cell").addClass("ui-state-hover")}},selected:function(g,e){clearTimeout(b.closing);var h=c.selectionMode,d=e.item;if(b._trigger("select",g,d))if(h=="single"){if(!b._usingRemoteData()){var f=a.inArray(d,b.items);if(f!=c.selectedIndex){b._input.val(d.label);var j=b.selectedItem;b.selectedItem=d;var i=c.selectedIndex;c.selectedIndex=f;if(b._select!=undefined){b._select[0].selectedIndex=c.selectedIndex;b._select.trigger("change")}b._trigger("changed",null,{oldItem:j,selectedItem:b.selectedItem,newIndex:c.selectedIndex,oldIndex:i})}}else if(b.selectedItem===null||!b._hasSameValueText(d,b.selectedItem)){b._input.val(d.label);b.selectedItem=d;b._trigger("changed",null,{selectedItem:d})}}else if(!b._usingRemoteData()){b.selectedItems=e.selectedItems;b._selectedItemsToInputVal(b.selectedItems);b._trigger("changed",null,{selectedItem:d,selectedItems:b.selectedItems})}(e.data==undefined||!e.data.notCloseAfterSelected)&&h=="single"&&b.close(g)},blur:function(b,a){if(c.columns.length>0){a.find(".ui-wijcombobox-row>.ui-wijcombobox-cell").removeClass("ui-state-hover");a.prev().removeClass("ui-wijcombobox-active-prev")}},itemrendering:function(g,f){var d=f,e="";if(d.isSeparator)e+=" ui-wijcombobox-separator";if(d.selected)e+=" ui-wijcombobox-selecteditem";e.length>0&&d.element.addClass(e);if(b._keypress&&c.isEditable&&c.columns.length==0&&c.highlightMatching&&a.trim(b._input.val()).length>0)d.text=d.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b._escapeRegex(b._input.val())+")(?![^<>]*>)(?![^&;]+;)","gi"),"<span class='ui-priority-primary'>$1</span>");else d.text=undefined},itemrendered:function(f,e){var b=e;if(b.cells==undefined)return;var c=b.element;c.empty();var d=a("<ul class='ui-wijcombobox-row'></ul>");a.each(b.cells,function(e,c){var b=a("<li class='ui-wijcombobox-cell ui-state-default'></li>");b.append(c);b.attr("title",c);d.append(b)});c.append(d)},resized:function(c,a){b.options.dropdownWidth=a.element.outerWidth();b.options.dropdownHeight=a.element.outerHeight();b._positionList()}}).zIndex(b._input.zIndex()+1).css({top:0,left:0}).hide().data("wijlist");b._menuUL=b.menu.ul;a.fn.bgiframe&&b.menu.element.bgiframe()},_selectedItemsToInputVal:function(d){var b="",c=this,e=c.options.multipleSelectionSeparator;c.selectedItems=d;a.each(d,function(c,a){b+=a.label+e});if(b.length>0)b=b.substr(0,b.lastIndexOf(e));c._input.val(b)},_createDOMElements:function(){var b=this,f=a("<div class='ui-wijcombobox ui-widget ui-helper-clearfix'><div class='ui-wijcombobox-wrapper ui-state-default ui-corner-all'></div></div>"),e=b.element,d;b._comboElement=f;if(e[0].tagName.toLowerCase()=="select"){b._select=e;e.addClass("ui-widget");d=b._input=a("<input />").insertAfter(e);b.options.data=b._convertSelectOptions()}else d=b._input=e;f.insertBefore(d);f.children(".ui-wijcombobox-wrapper").append(d);d.attr({autocomplete:"off",role:"textbox","aria-wijcombobox":"list","aria-haspopup":"true"}).addClass(g);b._oldWidth=e.css("width");b.options.isEditable==false&&d.attr("readonly","readonly");f.bind("mouseenter",function(){b._addInputFocus(true,c)}).bind("mouseleave",function(){b._addInputFocus(false,c)})},_convertSelectOptions:function(){var c=[],b=this;a.each(b._select.attr("options"),function(b,a){c.push({label:a.text,value:a.value})});b.options.selectedIndex=b._select[0].selectedIndex;return c},getComboElement:function(){return this._comboElement},_showTrigger:function(){var g=this,l=g.options,k=g._input,q=k.parent(),p=g._comboElement,b=g._triggerArrow,j=g._label;if(g._select!=undefined){k.width(g._select.width()+(l.data.length>20?l.selectElementWidthFix:0));g._select.hide()}p.width(q[0].offsetWidth);if(l.labelText!=null){j=g._label=a(i);q.append(j.html(l.labelText))}else if(j!=undefined){j.remove();g._label=undefined}if(l.showTrigger){k.removeClass("ui-corner-all");if(b==undefined){b=g._triggerArrow=a(h);p.append(b);b.bind("mouseover.triggerevent",g,function(d){if(l.disabled==true)return;var b=a(d.currentTarget);b.addClass(c)}).bind("mousedown.triggerevent",g,function(c){if(l.disabled==true)return;var b=a(c.currentTarget);b.addClass(d)}).bind("mouseup.triggerevent",g,function(c){var b=a(c.currentTarget);b.removeClass(d)}).bind("click.triggerevent",g,function(){if(l.disabled==true)return;g._triggerClick()})}if(l.triggerPosition==="right"){b.css({left:"",right:"0px"});b.removeClass(f);b.addClass(e)}else{b.css({right:"",left:"0px"});b.removeClass(e);b.addClass(f)}b.setOutHeight(p.innerHeight());var o=b.find("span");o.css("margin-left",(b.innerWidth()-o[0].offsetWidth)/2);o.css("margin-top",(b.innerHeight()-o[0].offsetHeight)/2)}else{if(b!=undefined){b.unbind(".triggerevent");b.remove();g._triggerArrow=undefined}k.removeClass("ui-corner-left");k.removeClass("ui-corner-right");k.addClass("ui-corner-all")}var m=0,r=0,n=0;if(j!=undefined)r+=j[0].offsetWidth;if(b!=undefined)n=b[0].offsetWidth;m=r+n;k.setOutWidth(q.innerWidth()-m);m=m==0?"":m;if(l.triggerPosition==="right"){k.css("margin-left","");k.css("margin-right",m);if(j!=undefined){j.css("left","");j.css("right",n)}}else{k.css("margin-right","");k.css("margin-left",m);if(j!=undefined){j.css("right","");j.css("left",n)}}},_triggerClick:function(c){var a=this;clearTimeout(a.closing);if(a.menu.element.is(":visible"))a.close();else{var b="";if(a._usingRemoteData())b=a._input.val();a.search(b,c)}},destroy:function(){var b=this,c=b.element;b.options.isEditable==false&&c.removeAttr("readonly");if(b._select!=undefined){b._select.removeClass("ui-widget");b._select.show();b._input.remove()}else{c.css("width",b._oldWidth);c.removeClass(g);c.removeAttr("autocomplete").removeAttr("role").removeAttr("aria-wijcombobox").removeAttr("aria-haspopup");c.insertBefore(b._comboElement);c.css("padding","")}b._comboElement.remove();b.menu.destroy();b.menu.element.remove();a.Widget.prototype.destroy.call(b)},_setOption:function(f,d){var c=this,e=c._comboElement,b=c.element;a.Widget.prototype._setOption.apply(c,arguments);if(f=="disabled")if(d){e.addClass("ui-wijcombobox-disabled ui-state-disabled");b.attr("disabled","disabled");c.close()}else{e.removeClass("ui-wijcombobox-disabled ui-state-disabled");b.removeAttr("disabled")}else if(f=="isEditable")if(d)b.attr("readonly","readonly");else b.removeAttr("readonly")},search:function(f,d){var b=this,g=b.options,c=g.data;clearTimeout(b.closing);var e={value:f,e:d,self:b};if(c!=null){if(!(d==="checkindex"))if(b._trigger("search",d,{datasrc:c,term:e})===false)return;if(a.isArray(c)){b._hideShowArrow(false);b._onListLoaded(c,e)}else{if(b._usingRemoteData()&&d!=undefined&&f.length<g.minLength)return;b._hideShowArrow(false);c.loaded=b._onListLoaded;c.load(e)}}},_usingRemoteData:function(){var b=this.options.data,c=false;if(!a.isArray(b)&&b!==null&&b.proxy!==null)c=true;return c},_hideShowArrow:function(c){var b=this,d=b.element,a=b._triggerArrow;a!=undefined&&a[c?"show":"hide"]();d[c?"removeClass":"addClass"]("ui-wijcombobox-loading")},_onListLoaded:function(h,e){var c=e.self,j=c._input,i=c.options,k=e.value,d=a.isArray(h)?h:h.items;c.items=d;if(e.e==="checkindex"){var f=i.selectedIndex;if(i.selectionMode==="multiple"&&a.isArray(f)){a.each(f,function(e,b){var a=d[b];a.selected=true;c.selectedItems.push(a)});j.val(c._selectedItemsToInputVal(c.selectedItems))}else{d[f].selected=true;c.selectedItem=d[f];j.val(c.selectedItem.label)}c._hideShowArrow(true);return}if(!c._usingRemoteData()){c._filter(d,k);g=a.grep(d,function(a){return!i.autoFilter||a.match})}else{c._topHit=null;var g=d}if(g.length>0){c._openlist(g,e);c._trigger("open");c._addInputFocus(true,b)}else c.close(null,true);c._hideShowArrow(true)},close:function(e,d){clearTimeout(this.closing);if(this.menu.element.is(":visible")){this._trigger("close",e);this.menu.deactivate();var c=this.options.hidingAnimation;if(d!=true&&c!=null)this.menu.element.hide(c.effect,c.options,c.speed,c.callback);else this.menu.element.hide();this._addInputFocus(false,b);a(document).unbind("click",self.closeOnClick)}},_change:function(){var a=this,e=a.options,f=e.forceSelectionText,d=e.selectionMode,b=a._input,g=b.val(),c=a.selectedItem;if(f)if(d=="single")if(c!=null)c.label!==g&&b.val(c.label);else b.val("");d=="multiple"&&a._selectedItemsToInputVal(a.selectedItems)},_openlist:function(m,j){var b=j.self,d=j.e,i=b._keypress=d!=undefined||d!=null,g,f=b.options,c=b.menu.element;c.zIndex(b.element.zIndex()+1);b.menu.setItems(m);b.menu.renderList();b.menu.element.show();if(f.dropdownWidth=="auto")g=b._comboElement.outerWidth();else g=f.dropdownWidth;var l=c.css("padding");c.css("padding","0px");c.setOutWidth(g);c.css("padding",l);var k=2,h=f.dropdownHeight;if(b._select!=undefined)h=20*b._menuUL.children(".ui-wijlist-item:first").outerHeight();var n=Math.min(b._menuUL.outerHeight()+k,h);c.setOutHeight(n);b.menu.refreshSuperPanel();b._positionList();!i&&b.selectedItem!=undefined&&b.menu.activate(null,b.selectedItem,true);if(i&&d.keyCode!=jQuery.ui.keyCode.BACKSPACE)if(f.isEditable)b._runAutoComplete();else b.menu.activate(null,b._topHit,true);else{var e=b.options.showingAnimation;if(b.options.showingAnimation!=null&&!(d!==undefined&&d.keyCode===jQuery.ui.keyCode.BACKSPACE)){b.menu.element.hide();b.menu.element.show(e.effect,e.options,e.speed,e.callback)}}a(document).bind("click",b,b.closeOnClick)},closeOnClick:function(c){var b=c.data,d=c.target;!a.contains(b._comboElement[0],d)&&!a.contains(b.menu.element[0],d)&&b.close()},_positionList:function(){var c=this,d=c.options.dropDownListPosition,b={my:"left top",at:"left bottom",of:c._comboElement,collision:"none"};b=a.extend(b,d);c.menu.element.position(b)},_runAutoComplete:function(){var a=this,c=a._input,b=a._topHit;if(!a.options.autoComplete||b==null)return;a.menu.activate(null,b,true);var e=c.val(),d=b.label;c.val(d);var f=e.length,g=d.length;a._selectText(f,g,c)},_selectText:function(d,e,c){var f=c.val(),a=c.get(0);if(f.length>0)if(a.setSelectionRange!=undefined)a.setSelectionRange(d,e);else if(a.createTextRange!=undefined){var b=a.createTextRange();b.moveStart("character",d);b.moveEnd("character",e-f.length);b.select()}},_onresize:function(a){var b=a.menu.element;a.options.dropdownWidth=b.get(0).offsetWidth;a.options.dropdownHeight=b.get(0).offsetHeight},_move:function(a,b){if(!this.menu.element.is(":visible")){this.search("",b);return}if(this.menu.first()&&/^previous/.test(a)||this.menu.last()&&/^next/.test(a)){this._input.val(this.term);this.menu.deactivate();return}this.menu[a](b)},_escapeRegex:function(a){return a===undefined?a:a.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")},_filter:function(d,e){var c=this._escapeRegex(e),f=new RegExp(c,"i"),b=null;a.each(d,function(e,a){if(c===undefined||c.length==0){a.match=true;return}var d=f.exec(a.label);if(d==null)a.match=false;else{if(b==null&&d.index==0)b=a;a.match=d.index>=0}});this._topHit=b;return d}})})(jQuery);