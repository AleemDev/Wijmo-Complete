/*
 *
 * Wijmo Library 0.8.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){window.wijinputcore={options:{activeField:0,keyDelay:800,autoNextField:true,culture:"",invalidClass:"ui-state-error",promptChar:"_",resetOnPrompt:true,resetOnSpace:true,allowPromptAsInput:false,hidePromptOnLeave:false,skipLiterals:true,passwordChar:"",nullText:"Enter here",showNullText:false,smartInputMode:true,hideEnter:false,disableUserInput:false,increment:1,buttonAlign:"right",showTrigger:false,showSpinner:false,comboItems:undefined,comboWidth:undefined,comboHeight:undefined},_create:function(){if(this.element.attr("tagName").toLowerCase()!=="input")throw"Target element is not a INPUT";a.effects.save(this.element,["width","height"]);var b=this.element.width();this.element.wrap("<div class='ui-wijinput ui-widget ui-helper-clearfix ui-state-default ui-corner-all'><span class='ui-wijinput-wrapper'></span></div>");this.element.addClass("ui-wijinput-input ui-corner-all");this.wrapper=this.element.parent();this.outerDiv=this.wrapper.parent();this.outerDiv.width(b);if(this.options.showTrigger){this.triggerBtn=a("<div class='ui-wijinput-trigger ui-state-default'><span class='ui-icon ui-icon-triangle-1-s'></span></div>");this.triggerBtn.addClass(this.options.buttonAlign==="left"?"ui-corner-left":"ui-corner-right");this.triggerBtn.appendTo(this.outerDiv)}if(this.options.showSpinner){this.spinner=a("<div class='ui-wijinput-spinner ui-wijinput-button'></div>");this.spinUp=a("<div class='ui-state-default ui-wijinput-spinup'><span class='ui-icon ui-icon-triangle-1-n'></span></div>");this.spinDown=a("<div class='ui-state-default ui-wijinput-spindown'><span class='ui-icon ui-icon-triangle-1-s'></span></div>");if(!this.options.showTrigger){this.spinUp.addClass(this.options.buttonAlign==="left"?"ui-corner-tl":"ui-corner-tr");this.spinDown.addClass(this.options.buttonAlign==="left"?"ui-corner-bl":"ui-corner-br")}this.spinner.append(this.spinUp).append(this.spinDown);this.spinner.appendTo(this.outerDiv)}if(this.options.showTrigger&&this.options.showSpinner)this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-spinner-trigger-left":"ui-input-spinner-trigger-right");else{this.options.showTrigger&&this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-trigger-left":"ui-input-trigger-right");this.options.showSpinner&&this.outerDiv.addClass(this.options.buttonAlign==="left"?"ui-input-spinner-left":"ui-input-spinner-right")}this.element.setOutWidth(this.outerDiv.width());this._initialize()},_createTextProvider:function(){return undefined},_beginUpdate:function(){},_endUpdate:function(){},_onTriggerClicked:function(){},_initialize:function(){this.element.data("initializing",true);this._trigger("initializing");this._createTextProvider();this._beginUpdate();this.element.data("errorstate",false);this.element.data("breakSpinner",true);this.element.data("prevCursorPos",-1);this.element.data("doubleBytes",false);this.element.data("isPassword",this.options.passwordChar.length>0&&this.element.attr("type")!=="password");this.options.showNullText&&this.option("hidePromptOnLeave",true);var c=function(a){return(!a.which?a.button:a.which)===1},b=this;this.triggerBtn&&this.triggerBtn.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:function(d){if(!c(d))return;b._addState("active",a(this));b._trigger("tiggermousedown")},mouseup:function(d){if(!c(d))return;b._stopEvent(d);b._stopSpin();b._removeState("active",a(this));b._trigger("triggermouseup");b._onTriggerClicked();b._trySetFocus()}});var d=function(d){if(!c(d))return;b._trySetFocus();b.element.data("breakSpinner",false);b._addState("active",a(this));b._doSpin(a(d.currentTarget).hasClass("ui-wijinput-spinup"),true)},e=function(d){if(!c(d))return;b._stopSpin();b._removeState("active",a(this))};this.spinUp&&this.spinUp.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:d,mouseup:e});this.spinDown&&this.spinDown.bind({mouseover:function(){b._addState("hover",a(this))},mouseout:function(){b._removeState("hover",a(this))},mousedown:d,mouseup:e});this.element.bind({"focus.wijinput":a.proxy(this._onFocus,this),"blur.wijinput":a.proxy(this._onBlur,this),"mouseup.wijinput":a.proxy(this._onMouseUp,this),"keypress.wijinput":a.proxy(this._onKeyPress,this),"keydown.wijinput":a.proxy(this._onKeyDown,this),"keyup.wijinput":a.proxy(this._onKeyUp,this),"change.wijinput":a.proxy(this._onChange,this),"paste.wijinput":a.proxy(this._onPast,this),"drop.wijinput":a.proxy(this._onDrop,this)});this.element.bind("propertychange.wijinput input.wijinput",a.proxy(this._onInput,this));this.element.data("preText",this.element.val());this.element.data("initializing",false);this._resetData();this._endUpdate();this._updateText(false);this._trigger("initialized")},_init:function(){},_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);switch(c){case"buttonAlign":case"showTrigger":case"showSpinner":this._destroy();this._create();break;case"resetOnPrompt":case"hidePromptOnLeave":this._updateText(false);break;case"passwordChar":this.element.data("isPassword",(b+"").length>0);this._updateText(false);break;case"showNullText":b&&this.option("hidePromptOnLeave",true);this._updateText(false);break;case"disabled":this.element.attr("disabled",b);this.element[b?addClass:removeClass](this.namespace+"-state-disabled");this.triggerBtn!==undefined&&this.triggerBtn[b?addClass:removeClass](this.namespace+"-state-disabled");this.spinup!==undefined&&this.spinup[b?addClass:removeClass](this.namespace+"-state-disabled");this.spindown!==undefined&&this.spindown[b?addClass:removeClass](this.namespace+"-state-disabled")}},destroy:function(){a.Widget.prototype.destroy.apply(this,arguments);this._destroy()},_destroy:function(){this.wrapper=undefined;this.outerDiv=undefined;this.element.unbind(".wijinput");this.element.removeData("errorstate");this.element.removeData("breakSpinner");this.element.removeData("prevCursorPos");this.element.removeData("doubleBytes");this.element.removeData("isPassword");this.element.removeClass("ui-wijinput-input");this.element.parent().replaceWith(this.element);this.element.parent().replaceWith(this.element);a.effects.restore(this.element,["width","height"])},widget:function(){return this.outerDiv},_getCulture:function(b){return a.findClosestCulture(b||this.options.culture)},_isPassword:function(){return!!this.element.data("isPassword")},_addState:function(b,a){a.is(":not(.ui-state-disabled)")&&a.addClass("ui-state-"+b)},_removeState:function(a,b){b.removeClass("ui-state-"+a)},_isInitialized:function(){return!this.element.data("initializing")},_setData:function(a){this.setText(a)},_resetData:function(){},_validateData:function(){},getText:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,false,false)},setText:function(a){if(!this._isInitialized())this.element.val(a);else{this._textProvider.set(a);this._updateText(false)}},selectText:function(a,b){if(this.element.is(":disabled"))return;this.element.wijtextselection(a,b)},focus:function(){if(this.element.is(":disabled"))return;this.element.get(0).focus()},_raiseTextChanged:function(){var a=this.element.val();if(this.element.data("preText")!==a){this._trigger("textchanged");this.element.data("preText",a)}},_raiseDataChanged:function(){},_allowEdit:function(){return!(this.element.attr("readOnly")&&this.element.is(":disabled"))},_updateText:function(a){if(!this._isInitialized())return;a=!!a;if(!a)this.element.val(this._textProvider.toString(!this._isPassword(),!!this.options.hidePromptOnLeave?this._isFocused():true,true));else{var b=this.element.wijtextselection();this.element.val(this._textProvider.toString(!this._isPassword(),!!this.options.hidePromptOnLeave?this._isFocused():true,true));if(this.element.is(":disabled"))return;this.selectText(b.start,b.end);this.element.data("prevCursorPos",b.start)}this._raiseTextChanged();this._raiseDataChanged()},_trySetFocus:function(){if(!this._isFocused())try{!this.options.disableUserInput&&this.element.focus()}catch(a){}},_deleteSelText:function(b){if(!this._allowEdit())return;var a=this.element.wijtextselection();b=!!b;if(b)if(a.end===a.start)if(a.end>=1){a.end=a.end-1;a.start=a.start-1}else return;else a.end=a.end-1;else a.end=a.end-1;if(a.end<a.start)a.end=a.start;var c=new wijInputResult;this._textProvider.removeAt(a.start,a.end,c);this._updateText(false);this.selectText(c.testPosition,c.testPosition)},_getTextWithPrompts:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,true,false)},_getTextWithLiterals:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,false,true)},_getTextWithPromptAndLiterals:function(){return!this._isInitialized()?this.element.val():this._textProvider.toString(true,true,true)},_fireIvalidInputEvent:function(){this._trigger("invalidinput");if(!this.element.data("errorstate")){var b=this.options.invalidClass||"ui-state-error";this.element.data("errorstate",true);var a=this;window.setTimeout(function(){a.outerDiv.removeClass(b);a.element.data("errorstate",false)},100);this.outerDiv.addClass(b)}},_onInput:function(b){if(!this.element.data("doubleBytes")||!this.element.data("lastSelection"))return;var f=this.element.wijtextselection(),c=this.element.data("lastSelection").start,d=f.end;this.element.data("doubleBytes",false);if(d>=c){var g=this.element.val(),e=g.substring(c,d),a=this;window.setTimeout(function(){if(!a.element.data("lastValue"))return;a.element.val(a.element.data("lastValue"));var d=a.element.data("lastSelection");a.element.wijtextselection(d);a.element.removeData("lastSelection");a.element.data("batchKeyPress",true);for(var c=0;c<e.length;c++){b.which=b.charCode=b.keyCode=e.charCodeAt(c);this._onKeyPress(b)}a.element.data("batchKeyPress",false)},1)}},_keyDownPreview:function(){return false},_onKeyDown:function(b){this.element.data("prevCursorPos",-1);if(!this._isInitialized())return;var c=this._getKeyCode(b);if(c===229){if(!this.element.data("lastSelection")){this.element.data("lastSelection",this.element.wijtextselection());this.element.data("lastValue",this.element.val())}this.element.data("doubleBytes",true);return}this.element.data("doubleBytes",false);if(this.options.disableUserInput){this._stopEvent(b);return}if(this._keyDownPreview(b)){this._stopEvent(b);return}switch(c){case a.ui.keyCode.UP:this._doSpin(true,false);this._stopEvent(b);return;case a.ui.keyCode.DOWN:this._doSpin(false,false);this._stopEvent(b);return}if(b.ctrlKey)switch(c){case a.ui.keyCode.INSERT:case 67:return}if(b.ctrlKey||b.altKey)return;switch(c){case 112:case 113:case 114:case 115:case 116:case 117:return;case a.ui.keyCode.BACKSPACE:this._deleteSelText(true);this._stopEvent(b);return;case a.ui.keyCode.DELETE:this._deleteSelText(false);this._stopEvent(b);return;case a.ui.keyCode.ENTER:if(!this.options.hideEnter)return;break;case a.ui.keyCode.ESCAPE:this._stopEvent(b);window.setTimeout(a.proxy(this,this._resetData),1);return;case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.ALT:this._stopEvent(b);return;case a.ui.keyCode.SHIFT:return}},_onKeyUp:function(b){if(this.element.data("doubleBytes"))return;var c=this._getKeyCode(b);if(!this._isInitialized())return;if(c===a.ui.keyCode.ENTER)return;if(c===a.ui.keyCode.ESCAPE)return;if(this.options.disableUserInput){this._raiseTextChanged();this._raiseDataChanged();return}this._stopEvent(b)},_getKeyCode:function(b){var a=window.navigator.userAgent;if(a.indexOf("iPod")!==-1||a.indexOf("iPhone")!==-1)switch(b.which){case 127:return 8}return b.which},_keyPressPreview:function(){return false},_onKeyPress:function(b){if(this.element.data("doubleBytes"))return;this.element.data("prevCursorPos",-1);if(this.options.disableUserInput)return;if(!this._allowEdit())return;if(b.ctrlKey&&b.keyCode==119){this._onPast(b);return}if(b.ctrlKey||b.altKey)if(b.which!==a.ui.keyCode.SPACE)return;if(b.which==0)return;if(this._keyPressPreview(b)){this._stopEvent(b);return}var c=this.element.wijtextselection(),f=String.fromCharCode(b.which);c.start<c.end&&this._textProvider.removeAt(c.start,c.end-1,new wijInputResult);var d=new wijInputResult,e=this._textProvider.insertAt(f,c.start,d);if(e){this._updateText(false);this.selectText(d.testPosition+1,d.testPosition+1)}else this._fireIvalidInputEvent();!this.element.data("batchKeyPress")&&this._stopEvent(b)},_afterFocused:function(){if(!!this.options.hidePromptOnLeave){var c=this.element.wijtextselection(),b=c.start;this._updateText(false);var d=this.element.val();if(d.length===b)b=0;!a.browser.safari&&this.selectText(b,b)}},_onFocus:function(){if(this.options.disableUserInput)return;this._addState("focus",this.outerDiv);if(!this.element.data("breakSpinner"))return;if(!this._isInitialized())return;if(!this._allowEdit())return;!this.element.data("focusNotCalledFirstTime")&&this.element.data("focusNotCalledFirstTime",(new Date).getTime());this._afterFocused()},_onBlur:function(){if(this.options.disableUserInput)return;if(this._isComboListVisible())return;this._removeState("focus",this.outerDiv);if(!this.element.data("breakSpinner")){this.element.get(0).focus();var a=this.element.data("prevCursorPos");a!==undefined&&a!==-1&&this.selectText(a,a);return}if(!this._isInitialized())return;if(!this._isFocused())return;this.element.data("value",this.element.val());var b=this;window.setTimeout(function(){b._onChange();b._updateText(false);b._validateData()},100)},_isFocused:function(){return this.outerDiv.hasClass("ui-state-focus")},_onMouseUp:function(){if(!this._isInitialized())return;if(this.element.is(":disabled"))return;var a=this.element.wijtextselection();this.element.data("prevCursorPos",a.start)},_onChange:function(){if(!this.element)return;var b=this.element.val(),a=this.getText();if(a!==b){a=this._getTextWithPrompts();if(a!==b){a=this._getTextWithPromptAndLiterals();a!==b&&this.setText(b)}}},_onPast:function(){window.setTimeout(a.proxy(this._onChange,this),1)},_onDrop:function(){window.setTimeout(a.proxy(this._onChange,this),1)},_stopEvent:function(a){a.stopPropagation();a.preventDefault()},_calcSpinInterval:function(){this._repeatingCount++;return this._repeatingCount>10?50:this._repeatingCount>4?100:this._repeatingCount>2?200:400},_doSpin:function(e,c){e=!!e;c=!!c;if(!this._allowEdit())return;if(c&&this.element.data("breakSpinner"))return;var d=this.element.wijtextselection(),b=new wijInputResult;if(this.element.data("focusNotCalledFirstTime")!==-9&&(new Date).getTime()-this.element.data("focusNotCalledFirstTime")<600){this.element.data("focusNotCalledFirstTime",-9);this.element.data("prevCursorPos",0)}if(this.element.data("prevCursorPos")===-1)this.element.data("prevCursorPos",d.start);else d.start=this.element.data("prevCursorPos");b.testPosition=d.start;this._textProvider[e?"incEnumPart":"decEnumPart"](d.start,b,this.options.increment);this._updateText(false);this.element.data("prevCursorPos",b.testPosition);this.selectText(b.testPosition,b.testPosition);c&&!this.element.data("breakSpinner")&&window.setTimeout(a.proxy(function(){this._doSpin(e,true)},this),this._calcSpinInterval())},_stopSpin:function(){this.element.data("breakSpinner",true);this._repeatingCount=0},_hasComboItems:function(){return!!this.options.comboItems&&this.options.comboItems.length},_isComboListVisible:function(){return!this._comboDiv?false:this._comboDiv.wijpopup("isVisible")},_popupComboList:function(){if(!this._hasComboItems())return;if(!this._allowEdit())return;if(this._isComboListVisible()){this._comboDiv.wijpopup("hide");return}if(this._comboDiv===undefined){this._comboDiv=a("<div></div>");this._comboDiv.appendTo(document.body);this._comboDiv.width(this.element.width());this._comboDiv.height(this.options.comboHeight||180);this._comboDiv.css("position","absolute");var c=this._normalize(this.options.comboItems),b=this;this._comboDiv.wijlist({autoSize:true,maxItemsCount:5,selected:function(c,a){b._setData(a.item.value);b._comboDiv.wijpopup("hide");b._trySetFocus()}});this._comboDiv.wijlist("setItems",c);this._comboDiv.wijlist("renderList");this._comboDiv.wijlist("refreshSuperPanel")}this._comboDiv.wijpopup({autoHide:true});this._comboDiv.wijpopup("show",{of:this.outerDiv,offset:"0 4"})},_normalize:function(b){return b.length&&b[0].label&&b[0].value?b:a.map(b,function(b){return typeof b==="string"?{label:b,value:b}:a.extend({label:b.label||b.value,value:b.value||b.label},b)})}};wijInputResult=function(){this.alphanumericCharacterExpected=-2;this.asciiCharacterExpected=-1;this.digitExpected=-3;this.invalidInput=-51;this.letterExpected=-4;this.nonEditPosition=-54;this.positionOutOfRange=-55;this.promptCharNotAllowed=-52;this.signedDigitExpected=-5;this.unavailableEditPosition=-53;this.testPosition=-1};wijInputResult.prototype={characterEscaped:1,noEffect:2,sideEffect:3,success:4,unknown:0,hint:0,clone:function(){var a=new wijInputResult;a.hint=this.hint;a.testPosition=this.testPosition;return a}}})(jQuery);