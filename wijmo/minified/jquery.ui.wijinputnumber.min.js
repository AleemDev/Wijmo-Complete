/*
 *
 * Wijmo Library 0.8.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){a.widget("ui.wijinputnumber",a.extend(true,{},wijinputcore,{options:{type:"numeric",value:0,minValue:0,maxValue:1e9,showGroup:false,decimalPlaces:2},_createTextProvider:function(){this._textProvider=new c(this,this.options.type)},_beginUpdate:function(){this.element.addClass("ui-wijinput-numeric");this.element.data("defaultValue",this.options.value);this.element.data("preValue",this.options.value)},_onTriggerClicked:function(){this._popupComboList()},_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);wijinputcore._setOption.apply(this,arguments);switch(c){case"minValue":case"maxValue":this._updateText(false);break;case"value":this.setValue(b);this._updateText(false);break;case"showGroup":case"decimalPlaces":case"culture":this._textProvider.updateStringFormat();this._updateText(false)}},_setData:function(a){this.setValue(a)},_resetData:function(){this.setValue(this.element.data("defaultValue"),true)},_validateData:function(){this._textProvider.checkAndRepairBounds(true,false)&&this._updateText(false)},_raiseDataChanged:function(){var a=this.options.value,b=this.element.data("preValue");this.element.data("preValue",a);b!==a&&this._trigger("valuechanged")},getValue:function(){var a=this._textProvider.getValue();if(a===undefined||a===null)a=this.getText();return a},setValue:function(a,c){try{c=!!c;if(typeof a==="boolean")a=a?"1":"0";if(this._textProvider.setValue(a))this._updateText(false);else if(c){var d="";d=this.getText();this.setText(a);a=a.trim();var b=this.getText().trim();if(b!==a){b=this._getTextWithPrompts().trim();if(b!==a){b=this._getTextWithPromptAndLiterals().trim();b!==a&&this.setText(d)}}}else this.setText(a);return true}catch(e){return false}},isValueNull:function(){try{return this._textProvider.isValueNull()}catch(a){return true}},_updateText:function(){if(!this._isInitialized())return;wijinputcore._updateText.apply(this,arguments);!this._textProvider.checkAndRepairBounds(false,false)&&this._trigger("valueboundsexceeded");this.options.value=this._textProvider.getValue()}}));var c=function(a,c){this.inputWidget=a;this._type=c;this._stringFormat=new b(this._type,this.inputWidget.options.decimalPlaces,this.inputWidget.options.showGroup,this._getCulture());this._stringFormat._setValueFromJSFloat(this.getValue())};c.prototype={_type:"numeric",_stringFormat:null,_getCulture:function(){return this.inputWidget._getCulture()},getDecimalSeparator:function(){return this._getCulture().numberFormat["."]},toString:function(b,a){if(!a&&this.inputWidget.options.showNullText)if(this.isValueNull())return this.inputWidget.options.nullText;return this._stringFormat.getFormattedValue()},isValueNull:function(){return!this.checkAndRepairBounds(false,true)},"set":function(a,b){this.clear();this.insertAt(a,0,b);return true},clear:function(){this._stringFormat.clear()},checkAndRepairBounds:function(a,c){var b=true;if(typeof a==="undefined")a=false;var d=this.inputWidget.options.minValue,e=this.inputWidget.options.maxValue;if(typeof c!=="undefined"&&c)return this._stringFormat.checkMinValue(d,false,true);if(!this._stringFormat.checkMinValue(d,a,false))b=false;if(!this._stringFormat.checkMaxValue(e,a))b=false;this.inputWidget.options.decimalPlaces>=0&&this._stringFormat.checkDigitsLimits(this.inputWidget.options.decimalPlaces);return b},countSubstring:function(c,b){var d=0,a=c.indexOf(b);while(a!==-1){d++;a=c.indexOf(b,a+1)}return d},getAdjustedPositionFromLeft:function(b){for(var e=this._stringFormat._currentText,c=0;c<e.length;c++){var d=e.charAt(c);if(!a.wij.charValidator.isDigit(d)&&(d!==","&&d!==".")||d==="0"){if(this._stringFormat.isZero()){if(b<c)b++}else if(b<=c)b++}else break}return b},getDecimalSeparatorPos:function(){var a=this._stringFormat._currentText;return a.indexOf(this.getDecimalSeparator())},insertAt:function(b,g,c){var h=this._getCulture().numberFormat;if(b===h["."])b=h["."];if(!c)c=new wijInputResult;if(b.length===1){if(b==="+"){this._stringFormat.setPositiveSign();this.checkAndRepairBounds(true,false);return true}if(b==="-"||b===")"||b==="("){this._stringFormat.invertSign();this.checkAndRepairBounds(true,false);return true}if(!a.wij.charValidator.isDigit(b)){if(b==="."){var j=this.getDecimalSeparatorPos();if(j>=0){c.testPosition=j;return true}}if(b!==","&&b!=="."&&b!==")"&&b!=="+"&&b!=="-"&&b!=="("&&b!==this.getDecimalSeparator())if(this._type==="percent"&&b===h.percent.symbol){c.testPosition=g;return true}else if(this._type==="currency"&&b===h.currency.symbol){c.testPosition=g;return true}else return false}}g=this.getAdjustedPositionFromLeft(g);var f=g,e=this._stringFormat._currentText;if(f>e.length)f=e.length-1;if(b.length===1)if(e.charAt(f)===b){c.testPosition=f;return true}var d=e.substring(0,f),i=e.substring(f,e.length);if(this._stringFormat.isZero())i=i.replace(new RegExp("[0]"),"");c.testPosition=d.length+b.length-1;this._stringFormat.deFormatValue(d+b+i);this.checkAndRepairBounds(true,false);try{if(b.length===1)if(this.inputWidget.options.showGroup){d=this._stringFormat._currentText.substring(0,d.length);if(this.countSubstring(d,this._stringFormat._groupSeparator)!==this.countSubstring(d,this._stringFormat._groupSeparator))c.testPosition=c.testPosition+1}else{var k=d.charAt(d.length-1),l=this._stringFormat._currentText.charAt(c.testPosition-1);if(l!==k)c.testPosition=c.testPosition-1}}catch(m){}return true},removeAt:function(b,e,a){var f=this._getCulture().numberFormat;if(!a)a=new wijInputResult;a.testPosition=b;try{var c=this._stringFormat._currentText;if(!(e-b)&&c.substring(b,e+1)===this.getDecimalSeparator())return false;var d=c.slice(0,b)+c.slice(e+1);if(d==="")d="0";this._stringFormat.deFormatValue(d);if(b===e&&this.inputWidget.options.showGroup)try{var g=this._stringFormat._currentText.substring(0,b);if(this.countSubstring(g,this._stringFormat._groupSeparator)!==this.countSubstring(d,this._stringFormat._groupSeparator)){a.testPosition=a.testPosition-1;if(c.indexOf(f.currency.symbol)===a.testPosition||c.indexOf(f.percent.symbol)===a.testPosition)a.testPosition=a.testPosition+1}}catch(h){}this.checkAndRepairBounds(true,false);return true}catch(h){}this.checkAndRepairBounds(true,false);return true},incEnumPart:function(c,a,b){if(!a)a=new wijInputResult;this._stringFormat.increment(b);return this.checkAndRepairBounds(true,false)},decEnumPart:function(c,a,b){if(!a)a=new wijInputResult;this._stringFormat.decrement(b);return this.checkAndRepairBounds(true,false)},getValue:function(){return this._stringFormat.getJSFloatValue()},setValue:function(a){try{this._stringFormat._setValueFromJSFloat(a);this.checkAndRepairBounds(true,false);return true}catch(b){return false}},updateStringFormat:function(){var a="0";if(typeof this._stringFormat!=="undefined")a=this._stringFormat._currentValueInString;this._stringFormat=new b(this._type,this.inputWidget.options.decimalPlaces,this.inputWidget.options.showGroup,this._getCulture());this._stringFormat._currentValueInString=a}};var b=function(d,a,c,b){this.type=d;this.digitsPlaces=a;this.showGroup=c;this.culture=b};b.prototype={_currentValueInString:"0",_currentText:"0",_groupSeparator:" ",type:"numeric",digitsPlaces:0,showGroup:false,culture:null,deFormatValue:function(a){var b=this.culture.numberFormat,g=this.isNegtive(a);a=a.replace("(","");a=a.replace(")","");a=a.replace("-","");a=a.replace(b.percent.symbol,"");a=a.replace(b.currency.symbol,"");var d=b[","],e=b["."];switch(this.type){case"percent":d=b.percent[","];e=b.percent["."];break;case"currency":d=b.currency[","];e=b.currency["."]}this._groupSeparator=d;var c=new RegExp("["+d+"]","g");a=a.replace(c,"");c=new RegExp("["+e+"]","g");a=a.replace(c,".");c=new RegExp("[ ]","g");a=a.replace(c,"");try{var h=new RegExp("([\\d\\.])+"),f=h.exec(a);if(f)a=f[0];if(g)a="-"+a;this._currentValueInString=a;this._currentText=this.formatValue(a)}catch(i){}},isNegtive:function(a){return a.indexOf("-")!==-1||a.indexOf("(")!==-1},formatValue:function(c){var a=this.culture.numberFormat;c=""+c+"";var j=this.digitsPlaces,g=" ",e=".",f=2,i=this.isNegtive(c),d=new Array(3);d.push(3);var h="n";switch(this.type){case"numeric":h=i?a.pattern[0]:"n";g=a[","];e=a["."];f=a.decimals;d=a.groupSizes;break;case"percent":h=a.percent.pattern[i?0:1];g=a.percent[","];e=a.percent["."];f=a.percent.decimals;d=a.percent.groupSizes;break;case"currency":h=a.currency.pattern[i?0:1];g=a.currency[","];e=a.currency["."];f=a.currency.decimals;d=a.currency.groupSizes}if(j!==-2)f=j;if(!this.showGroup)d=[0];c=c.replace(new RegExp("^[0]+"),"");var b=this.formatDigit(c,g,e,f,d);b=b.replace(new RegExp("^[0]+"),"");if(b.indexOf(e)===0)b="0"+b;if(b==="")b="0";this._currentValueInString=c;this._currentText=this.applyFormatPattern(h,b,a.percent.symbol,a.currency.symbol);return this._currentText},getFormattedValue:function(){return this.formatValue(this._currentValueInString)},getJSFloatValue:function(){try{return this._currentValueInString===""?0:parseFloat(this._currentValueInString)}catch(a){return Number.NaN}},clear:function(){this._currentValueInString="0";this._currentText="0"},_setValueFromJSFloat:function(a){try{this._currentValueInString=""+a+"";this.formatValue(a);return true}catch(b){return false}},isZero:function(){try{var a=this._currentValueInString.replace("-","");a=a.replace("(","");a=a.replace(")","");if(!a.length)a="0";var b=parseFloat(a);if(b!==Number.NaN&&!b)return true}catch(c){}return false},setPositiveSign:function(){this._currentValueInString=this._currentValueInString.replace("-","");this._currentValueInString=this._currentValueInString.replace("(","");this._currentValueInString=this._currentValueInString.replace(")","")},invertSign:function(){var a=false;if(this._currentValueInString.indexOf("-")!==-1||this._currentValueInString.indexOf("(")!==-1)a=true;if(a)this.setPositiveSign();else this._currentValueInString=!this._currentValueInString.length?"0":"-"+this._currentValueInString;if(this.isZero())this._currentValueInString="0";this.formatValue(this._currentValueInString)},increment:function(b){if(b===undefined)b=1;try{var a=this._currentValueInString.split(".");this._currentValueInString=a[0]*1+b+""+(a.length>1?"."+a[1]:"")}catch(c){}},decrement:function(b){if(b===undefined)b=1;try{var a=this._currentValueInString.split(".");this._currentValueInString=a[0]*1-b+""+(a.length>1?"."+a[1]:"")}catch(c){}},checkDigitsLimits:function(f){try{var a=this._currentValueInString.split(".");if(!a.length||a.length===1&&a[0]==="")return;var d="";if(a.length>1)d=a[1];for(var b="",c=0;c<f;c++){var e="0";if(d.length>c)e=d.charAt(c);b=b+e}if(b.length>0)this._currentValueInString=a[0]+"."+b;else this._currentValueInString=a[0]}catch(g){}},checkMinValue:function(g,i,h){if(typeof h==="undefined")h=false;var d=true;try{var a=this._currentValueInString.split("."),b=parseFloat(a[0]===""||a[0]==="-"?"0":a[0]),c=0;if(a.length>1&&parseFloat(a[1])>0)c=parseFloat("1."+a[1]);if(b<0||a[0]==="-")c=c*-1;g=""+g+"";a=g.split(".");var e=parseFloat(a[0]),f=0;if(a.length>1&&parseFloat(a[1])>0)f=parseFloat("1."+a[1]);if(b>e)return true;if(b<e||h&&b===e&&c<=f)d=false;else if(b===e&&b<0&&c>f)d=false;else if(b===e&&b>=0&&c<f)d=false;if(!d&&i)this._currentValueInString=""+g+""}catch(j){}return d},checkMaxValue:function(f,h){var c=true;try{var a=this._currentValueInString.split("."),b=parseFloat(a[0]===""||a[0]==="-"?"0":a[0]),d=0;if(a.length>1&&parseFloat(a[1])>0)d=parseFloat("1."+a[1]);if(b<0||a[0]==="-")d=d*-1;f=""+f+"";a=f.split(".");var e=parseFloat(a[0]),g=0;if(a.length>1&&parseFloat(a[1])>0)g=parseFloat("1."+a[1]);if(b<e)return true;if(b>e)c=false;if(b===e&&b>=0&&d>g)c=false;if(b===e&&b<0&&d<g)c=false;if(!c&&h)this._currentValueInString=""+f+""}catch(i){}return c},applyFormatPattern:function(f,e,d,c){var a=f,b=new RegExp("[n]","g");a=a.replace(b,e);b=new RegExp("[%]","g");a=a.replace(b,d);b=new RegExp("[$]","g");a=a.replace(b,c);return a},formatDigit:function(l,k,g,j,i){var a=""+l+"";a=a.replace("-","");a=a.replace("(","");a=a.replace(")","");var c=a.indexOf(g);if(c===-1)c=a.indexOf(".");if(c===-1)c=a.indexOf(",");if(c===-1)c=a.length;for(var b="",f=0,h=0,e,d=a.length-1;d>=0;d--){e=a.charAt(d);if(d<c){b=e+b;h++;if(h===i[f]*1&&i[f]*1&&d){b=k+b;h=0;if(i.length-1>f)f++}}}if(j>0){b=b+g;for(var d=0;d<j;d++){e="0";if(d+c+1<a.length)e=a.charAt(d+c+1);b=b+e}}if(j===-1)if(c<a.length-1){b=b+g;b=b+a.substr(c+1)}return b}}})(jQuery);